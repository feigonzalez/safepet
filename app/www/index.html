<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/style.css">
	<script src="assets/app.js"></script>
	
	<!-- Leaflet CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
	
	<!-- Leaflet JavaScript -->
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	
	<style>
		.heroTitle{font-weight:700;font-size:1.15rem}
		.quickGrid{grid-template-columns:repeat(3,1fr);gap:0.5rem}
		.quickItem{display:flex;flex-direction:column;align-items:center;gap:0.35rem;padding:0.5rem;border:solid 1px var(--brand-border);border-radius:0.75rem;background:#fff}
		
		/* Asegurar que el footer sea visible */
		.row.footer {
			background: white;
			padding: 0.5rem;
			box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
		}
		
		/* Contenedor del mapa - configuración correcta para Leaflet */
		.map-container {
			height: calc(100vh - 160px);
			position: relative;
			width: 100%;
		}
		
		/* Estilos para el mapa - configuración específica para Leaflet */
		#map {
			height: 100%;
			width: 100%;
			min-height: 400px;
			z-index: 1;
		}
		
		/* Controles del mapa */
		.map-controls {
			position: absolute;
			top: 10px;
			left: 10px;
			z-index: 1000;
			display: flex;
			flex-direction: column;
			gap: 8px;
		}
		
		.map-control-btn {
			background: white;
			border: none;
			border-radius: 6px;
			padding: 8px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.15);
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			width: 40px;
			height: 40px;
			transition: all 0.2s ease;
		}
		
		.map-control-btn:hover {
			background: #f5f5f5;
			transform: translateY(-1px);
		}
		
		.map-control-btn:active {
			transform: translateY(0);
		}
		
		/* Popup personalizado */
		.custom-popup {
			font-family: 'Poppins', sans-serif;
		}
		
		.popup-content {
			text-align: center;
			padding: 8px;
		}
		
		.popup-title {
			font-weight: 600;
			margin-bottom: 4px;
			color: #333;
		}
		
		.popup-description {
			font-size: 0.9rem;
			color: #666;
		}
		
		/* Estilos específicos para popups de refugios */
		.shelter-popup {
			min-width: 280px;
		}
		
		.shelter-details {
			margin-top: 12px;
		}
		
		.shelter-info {
			margin-bottom: 8px;
			padding: 6px 0;
			border-bottom: 1px solid #eee;
		}
		
		.shelter-info:last-child {
			border-bottom: none;
		}
		
		.shelter-info strong {
			color: #28a745;
		}
		
		.shelter-info a {
			color: #007bff;
			text-decoration: none;
		}
		
		.shelter-info a:hover {
			text-decoration: underline;
		}
	</style>
</head>

<body class="column size-full-height">

	<div class="pos-fixed pos-top pos-right" style="top: 20px; right: 20px; z-index: 1000; display: flex; gap: 8px;">
		<a class="button bg-redpale round" role="button" href="notifications.html" style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background-color: #ff6b6b; color: white; border-radius: 50%; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
			<span style="font-size: 18px;">🔔</span>
		</a>
		
	</div>


	<div class="row flex-grow map-container">
		<div class="column size-full-height">
			<!-- Controles del mapa -->
			<div class="map-controls">
				<button class="map-control-btn" onclick="centerOnUser()" title="Mi ubicación">
					<span class="icon" data-icon="location"></span>📍
				</button>
				<button class="map-control-btn" onclick="togglePetMarkers()" title="Mostrar/Ocultar mascotas">
					<span class="icon" data-icon="pets"></span>🐕
				</button>
				<button class="map-control-btn" onclick="toggleAlerts()" title="Mostrar/Ocultar alertas">
					<span class="icon" data-icon="warning"></span>⚠️
				</button>
				<button class="map-control-btn" onclick="toggleShelters()" title="Mostrar/Ocultar refugios">
					🏠
				</button>
			</div>
			
			<!-- Mapa real con Leaflet -->
			<div id="map"></div>
		</div>
	</div>

	<script>
		// Variables globales para el mapa
		let map = null;
		let userMarker = null;
		let mapInitialized = false;
		let petMarkers = [];
		let alertMarkers = [];
		let shelterMarkers = [];
		let showShelters = true;
		let showingPets = true;
		let showingAlerts = true;
		let userLocation = null; // Para almacenar la ubicación del usuario

		// Inicializar el mapa con configuración optimizada para Leaflet
		function initMap() {
			console.log('Inicializando mapa Leaflet...');
			
			// Verificar si el mapa ya está inicializado
			if (mapInitialized && map) {
				console.log('Mapa ya está inicializado, saltando...');
				return;
			}
			
			// Verificar que Leaflet esté disponible
			if (typeof L === 'undefined') {
				console.error('Leaflet.js no está cargado correctamente');
				document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Error: No se pudo cargar el mapa</div>';
				return;
			}
			
			// Verificar que el contenedor del mapa exista
			const mapContainer = document.getElementById('map');
			if (!mapContainer) {
				console.error('Contenedor #map no encontrado en el DOM');
				return;
			}
			
			console.log('Contenedor del mapa encontrado:', mapContainer);
			
			try {
				// Limpiar el contenedor si ya tiene contenido
				mapContainer.innerHTML = '';
				
				// Coordenadas por defecto (Santiago, Chile)
				const defaultLat = -33.4489;
				const defaultLng = -70.6693;

				// Crear el mapa con configuración específica de Leaflet
				map = L.map('map', {
					center: [defaultLat, defaultLng],
					zoom: 13,
					zoomControl: true,
					attributionControl: true,
					scrollWheelZoom: true,
					doubleClickZoom: true,
					boxZoom: true,
					keyboard: true,
					dragging: true,
					touchZoom: true
				});
				
				console.log('Mapa Leaflet inicializado correctamente');
				
				// Marcar como inicializado
				mapInitialized = true;

				// Agregar capa de tiles de OpenStreetMap
				const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
					maxZoom: 19,
					minZoom: 1,
					subdomains: ['a', 'b', 'c']
				});
				
				tileLayer.addTo(map);
				console.log('Capa de tiles agregada correctamente');

				// Forzar que el mapa se redimensione correctamente
				setTimeout(() => {
					if (map) {
						map.invalidateSize(true);
						console.log('Mapa redimensionado y actualizado');
					}
				}, 250);

				// Agregar marcadores de ejemplo
				addSamplePetMarkers();
				addSampleAlertMarkers();
				addSampleShelterMarkers();
				console.log('Marcadores de ejemplo agregados');

				// Intentar obtener geolocalización del usuario
				if (navigator.geolocation) {
					console.log('Solicitando geolocalización...');
					navigator.geolocation.getCurrentPosition(
						function(position) {
							const userLat = position.coords.latitude;
							const userLng = position.coords.longitude;
							console.log('Ubicación obtenida:', userLat, userLng);
							
							// Almacenar la ubicación del usuario
							userLocation = { lat: userLat, lng: userLng };
							
							// Centrar el mapa en la ubicación del usuario
							if (map) {
								map.setView([userLat, userLng], 15);
								
								// Remover marcador anterior si existe
								if (userMarker) {
									map.removeLayer(userMarker);
								}
								
								// Agregar marcador del usuario con icono personalizado
								userMarker = L.marker([userLat, userLng], {
									icon: L.divIcon({
										className: 'user-location-marker',
										html: '<div style="background-color: #007bff; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">📍</div>',
										iconSize: [26, 26],
										iconAnchor: [13, 13]
									})
								})
								.addTo(map)
								.bindPopup('<div class="popup-content"><div class="popup-title">Tu ubicación</div><div class="popup-description">Estás aquí</div></div>')
								.openPopup();
								
								// Actualizar refugios y alertas basados en la ubicación
								updateLocationBasedContent();
							}
						},
						function(error) {
							console.log('Error obteniendo geolocalización:', error.message);
							console.log('Código de error:', error.code);
							
							// Usar ubicación por defecto de Santiago y generar contenido
							const defaultLat = -33.4489;
							const defaultLng = -70.6693;
							userLocation = { lat: defaultLat, lng: defaultLng };
							
							console.log('Usando ubicación por defecto de Santiago:', userLocation);
							
							// Actualizar refugios y alertas basados en la ubicación por defecto
							updateLocationBasedContent();
							
							// Mantener ubicación por defecto en Santiago
						},
						{
							enableHighAccuracy: true,
							timeout: 10000,
							maximumAge: 300000
						}
					);
					} else {
						console.log('Geolocalización no disponible en este navegador');
						
						// Usar ubicación por defecto de Santiago y generar contenido
						const defaultLat = -33.4489;
						const defaultLng = -70.6693;
						userLocation = { lat: defaultLat, lng: defaultLng };
						
						console.log('Usando ubicación por defecto de Santiago (navegador sin geolocalización):', userLocation);
						
						// Actualizar refugios y alertas basados en la ubicación por defecto
						updateLocationBasedContent();
					}
				
			} catch (error) {
				console.error('Error crítico inicializando el mapa:', error);
				// Resetear el estado si hay error
				mapInitialized = false;
				map = null;
				document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; color: #ff0000;">Error: ' + error.message + '</div>';
			}
		}

		// Centrar en la ubicación del usuario
		function centerOnUser() {
			console.log('Botón de ubicación presionado');
			if (!map) {
				console.error('Mapa no está inicializado');
				alert('El mapa no está listo. Espera un momento e intenta de nuevo.');
				return;
			}

			if (navigator.geolocation) {
				console.log('Solicitando ubicación del usuario...');
				
				// Mostrar indicador de carga
				const loadingDiv = document.createElement('div');
				loadingDiv.id = 'location-loading';
				loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
				loadingDiv.innerHTML = '<div>📍 Obteniendo tu ubicación...</div>';
				document.body.appendChild(loadingDiv);

				navigator.geolocation.getCurrentPosition(
					function(position) {
						console.log('Ubicación obtenida exitosamente:', position.coords.latitude, position.coords.longitude);
						const userLat = position.coords.latitude;
						const userLng = position.coords.longitude;
						
						// Almacenar la ubicación del usuario
						userLocation = { lat: userLat, lng: userLng };
						
						// Remover indicador de carga
						document.body.removeChild(loadingDiv);
						
						// Centrar el mapa en la ubicación del usuario
						map.setView([userLat, userLng], 16);
						
						// Remover marcador anterior si existe
						if (userMarker) {
							map.removeLayer(userMarker);
						}
						
						// Agregar marcador del usuario
						userMarker = L.marker([userLat, userLng], {
							icon: L.divIcon({
								className: 'user-location-marker',
								html: '<div style="background-color: #007bff; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);">📍</div>',
								iconSize: [30, 30],
								iconAnchor: [15, 15]
							})
						})
						.addTo(map)
						.bindPopup('<div class="popup-content"><div class="popup-title">Tu ubicación actual</div><div class="popup-description">Lat: ' + userLat.toFixed(6) + '<br>Lng: ' + userLng.toFixed(6) + '</div></div>')
						.openPopup();
						
						// Actualizar refugios y alertas basados en la ubicación
						updateLocationBasedContent();
						
						console.log('Marcador de usuario agregado correctamente');
					},
					function(error) {
						console.error('Error obteniendo geolocalización:', error.message || error);
						
						// Remover indicador de carga si existe
						const loadingElement = document.getElementById('location-loading');
						if (loadingElement) {
							document.body.removeChild(loadingElement);
						}
						
						let errorMessage = 'No se pudo obtener tu ubicación. ';
						switch(error.code) {
							case error.PERMISSION_DENIED:
								errorMessage += 'Permisos de ubicación denegados. Usando ubicación por defecto.';
								break;
							case error.POSITION_UNAVAILABLE:
								errorMessage += 'Ubicación no disponible. Usando ubicación por defecto.';
								break;
							case error.TIMEOUT:
								errorMessage += 'Tiempo de espera agotado. Usando ubicación por defecto.';
								break;
							default:
								errorMessage += 'Error desconocido. Usando ubicación por defecto.';
								break;
						}
						
						console.log(errorMessage);
						
						// Usar ubicación por defecto de Santiago
						const defaultLat = -33.4489;
						const defaultLng = -70.6693;
						userLocation = { lat: defaultLat, lng: defaultLng };
						
						// Centrar el mapa en la ubicación por defecto
						map.setView([defaultLat, defaultLng], 13);
						
						// Remover marcador anterior si existe
						if (userMarker) {
							map.removeLayer(userMarker);
						}
						
						// Agregar marcador en la ubicación por defecto
						userMarker = L.marker([defaultLat, defaultLng], {
							icon: L.divIcon({
								className: 'default-location-marker',
								html: '<div style="background-color: #28a745; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);">🏠</div>',
								iconSize: [30, 30],
								iconAnchor: [15, 15]
							})
						})
						.addTo(map)
						.bindPopup('<div class="popup-content"><div class="popup-title">Ubicación por defecto</div><div class="popup-description">Santiago, Chile<br>Lat: ' + defaultLat.toFixed(6) + '<br>Lng: ' + defaultLng.toFixed(6) + '</div></div>');
						
						// Actualizar refugios y alertas basados en la ubicación por defecto
						updateLocationBasedContent();
						
						// Mostrar mensaje informativo en lugar de alert
						const messageDiv = document.createElement('div');
						messageDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ffc107; color: #856404; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; text-align: center; max-width: 300px;';
						messageDiv.innerHTML = '📍 Usando ubicación por defecto (Santiago)';
						document.body.appendChild(messageDiv);
						
						// Remover mensaje después de 3 segundos
						setTimeout(() => {
							if (document.body.contains(messageDiv)) {
								document.body.removeChild(messageDiv);
							}
						}, 3000);
					},
					{
						enableHighAccuracy: true,
						timeout: 15000,
						maximumAge: 60000
					}
				);
			} else {
				alert('Tu navegador no soporta geolocalización.');
			}
		}

		// Alternar visibilidad de marcadores de mascotas
		function togglePetMarkers() {
			showingPets = !showingPets;
			petMarkers.forEach(marker => {
				if (showingPets) {
					map.addLayer(marker);
				} else {
					map.removeLayer(marker);
				}
			});
		}

		// Alternar visibilidad de marcadores de alertas
		function toggleAlerts() {
			showingAlerts = !showingAlerts;
			alertMarkers.forEach(marker => {
				if (showingAlerts) {
					map.addLayer(marker);
				} else {
					map.removeLayer(marker);
				}
			});
		}

		// Alternar visibilidad de marcadores de refugios
		function toggleShelters() {
			showShelters = !showShelters;
			shelterMarkers.forEach(marker => {
				if (showShelters) {
					map.addLayer(marker);
				} else {
					map.removeLayer(marker);
				}
			});
		}

		// Función para actualizar contenido basado en la ubicación del usuario
		function updateLocationBasedContent() {
			if (!userLocation) {
				console.log('No hay ubicación del usuario disponible');
				return;
			}
			
			console.log('Actualizando contenido basado en ubicación:', userLocation);
			
			// Limpiar marcadores existentes
			clearAllMarkers();
			
			// Generar refugios cerca del usuario
			generateNearbyContent();
		}
		
		// Función para limpiar todos los marcadores
		function clearAllMarkers() {
			// Limpiar refugios
			shelterMarkers.forEach(marker => {
				if (map.hasLayer(marker)) {
					map.removeLayer(marker);
				}
			});
			shelterMarkers = [];
			
			// Limpiar alertas
			alertMarkers.forEach(marker => {
				if (map.hasLayer(marker)) {
					map.removeLayer(marker);
				}
			});
			alertMarkers = [];
			
			// Limpiar mascotas (mantener las existentes por ahora)
			petMarkers.forEach(marker => {
				if (map.hasLayer(marker)) {
					map.removeLayer(marker);
				}
			});
			petMarkers = [];
		}
		
		// Función para generar contenido cerca del usuario
		function generateNearbyContent() {
			if (!userLocation) return;
			
			// Generar refugios cerca del usuario (radio de ~2-5 km)
			const nearbyRefuges = [
				{
					lat: userLocation.lat + (Math.random() - 0.5) * 0.04,
					lng: userLocation.lng + (Math.random() - 0.5) * 0.04,
					name: "Refugio Esperanza Local",
					description: "Refugio para perros y gatos abandonados",
					address: "Cerca de tu ubicación",
					phone: "+56 2 2345 6789",
					hours: "Lun-Vie: 9:00-18:00, Sáb: 9:00-14:00"
				},
				{
					lat: userLocation.lat + (Math.random() - 0.5) * 0.03,
					lng: userLocation.lng + (Math.random() - 0.5) * 0.03,
					name: "Hogar Animal Cercano",
					description: "Centro de rescate y adopción",
					address: "En tu zona",
					phone: "+56 2 2876 5432",
					hours: "Mar-Dom: 10:00-17:00"
				},
				{
					lat: userLocation.lat + (Math.random() - 0.5) * 0.025,
					lng: userLocation.lng + (Math.random() - 0.5) * 0.025,
					name: "Fundación Patitas Local",
					description: "Refugio especializado en animales heridos",
					address: "Cerca de ti",
					phone: "+56 2 2654 3210",
					hours: "Lun-Sáb: 8:00-20:00"
				}
			];
			
			// Agregar marcadores de refugios
			nearbyRefuges.forEach(shelter => {
				const marker = L.marker([shelter.lat, shelter.lng], {
					icon: L.divIcon({
						className: 'custom-div-icon',
						html: '<div style="background-color: #28a745; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">🏠</div>',
						iconSize: [32, 32],
						iconAnchor: [16, 16]
					})
				})
				.addTo(map)
				.bindPopup(`
					<div class="shelter-popup">
						<div class="popup-title">${shelter.name}</div>
						<div class="shelter-details">
							<div class="popup-description">${shelter.description}</div>
							<div class="shelter-info">
								<div><strong>📍 Dirección:</strong> ${shelter.address}</div>
								<div><strong>📞 Teléfono:</strong> <a href="tel:${shelter.phone}">${shelter.phone}</a></div>
								<div><strong>🕒 Horarios:</strong> ${shelter.hours}</div>
							</div>
						</div>
					</div>
				`);
				
				if (showShelters) {
					shelterMarkers.push(marker);
				}
			});
			
			// Generar alertas/reportes cerca del usuario
			const nearbyAlerts = [
				{
					lat: userLocation.lat + (Math.random() - 0.5) * 0.02,
					lng: userLocation.lng + (Math.random() - 0.5) * 0.02,
					title: "Mascota encontrada cerca",
					description: "Perro encontrado en tu zona - hace 1 hora"
				},
				{
					lat: userLocation.lat + (Math.random() - 0.5) * 0.015,
					lng: userLocation.lng + (Math.random() - 0.5) * 0.015,
					title: "Avistamiento local",
					description: "Gato visto en tu área - hace 30 min"
				},
				{
					lat: userLocation.lat + (Math.random() - 0.5) * 0.01,
					lng: userLocation.lng + (Math.random() - 0.5) * 0.01,
					title: "Reporte cercano",
					description: "Mascota perdida reportada cerca de ti"
				}
			];
			
			// Agregar marcadores de alertas
			nearbyAlerts.forEach(alert => {
				const marker = L.marker([alert.lat, alert.lng], {
					icon: L.divIcon({
						className: 'custom-div-icon',
						html: '<div style="background-color: #4ecdc4; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">⚠️</div>',
						iconSize: [30, 30],
						iconAnchor: [15, 15]
					})
				})
				.addTo(map)
				.bindPopup(`<div class="popup-content"><div class="popup-title">${alert.title}</div><div class="popup-description">${alert.description}</div></div>`);
				
				if (showingAlerts) {
					alertMarkers.push(marker);
				}
			});
			
			// Generar mascotas perdidas cerca del usuario
			const nearbyPets = [
				{
					lat: userLocation.lat + (Math.random() - 0.5) * 0.018,
					lng: userLocation.lng + (Math.random() - 0.5) * 0.018,
					name: "Luna",
					description: "Gata perdida cerca de tu ubicación - hace 2 horas",
					type: "lost"
				},
				{
					lat: userLocation.lat + (Math.random() - 0.5) * 0.012,
					lng: userLocation.lng + (Math.random() - 0.5) * 0.012,
					name: "Max",
					description: "Perro perdido en tu zona - reportado hace 1 hora",
					type: "lost"
				}
			];
			
			// Agregar marcadores de mascotas
			nearbyPets.forEach(pet => {
				const marker = L.marker([pet.lat, pet.lng], {
					icon: L.divIcon({
						className: 'custom-div-icon',
						html: '<div style="background-color: #ff6b6b; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">🐕</div>',
						iconSize: [30, 30],
						iconAnchor: [15, 15]
					})
				})
				.addTo(map)
				.bindPopup(`<div class="popup-content"><div class="popup-title">${pet.name}</div><div class="popup-description">${pet.description}</div></div>`);
				
				if (showingPets) {
					petMarkers.push(marker);
				}
			});
			
			console.log('Contenido basado en ubicación generado:', {
				refugios: nearbyRefuges.length,
				alertas: nearbyAlerts.length,
				mascotas: nearbyPets.length
			});
		}

		// Agregar marcadores de ejemplo de mascotas
		function addSamplePetMarkers() {
			const samplePets = [
				{
					lat: -33.4489 + 0.01,
					lng: -70.6693 + 0.01,
					name: "Covellina",
					description: "Gata perdida - Última vez vista aquí",
					type: "lost"
				},
				{
					lat: -33.4489 - 0.008,
					lng: -70.6693 + 0.015,
					name: "Dargón",
					description: "Perro perdido - Reportado hace 2 horas",
					type: "lost"
				}
			];

			samplePets.forEach(pet => {
				const marker = L.marker([pet.lat, pet.lng], {
					icon: L.divIcon({
						className: 'custom-div-icon',
						html: '<div style="background-color: #ff6b6b; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">🐕</div>',
						iconSize: [30, 30],
						iconAnchor: [15, 15]
					})
				})
				.addTo(map)
				.bindPopup(`<div class="popup-content"><div class="popup-title">${pet.name}</div><div class="popup-description">${pet.description}</div></div>`);
				
				petMarkers.push(marker);
			});
		}

		// Agregar marcadores de ejemplo de alertas
		function addSampleAlertMarkers() {
			const sampleAlerts = [
				{
					lat: -33.4489 + 0.005,
					lng: -70.6693 - 0.01,
					title: "Mascota encontrada",
					description: "Perro encontrado en el parque"
				},
				{
					lat: -33.4489 - 0.012,
					lng: -70.6693 - 0.008,
					title: "Avistamiento",
					description: "Gato visto en esta zona"
				}
			];

			sampleAlerts.forEach(alert => {
				const marker = L.marker([alert.lat, alert.lng], {
					icon: L.divIcon({
						className: 'custom-div-icon',
						html: '<div style="background-color: #4ecdc4; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">⚠️</div>',
						iconSize: [30, 30],
						iconAnchor: [15, 15]
					})
				})
				.addTo(map)
				.bindPopup(`<div class="popup-content"><div class="popup-title">${alert.title}</div><div class="popup-description">${alert.description}</div></div>`);
				
				alertMarkers.push(marker);
			});
		}

		// Agregar marcadores de ejemplo de refugios
		function addSampleShelterMarkers() {
			const sampleShelters = [
				{
					lat: -33.4489 + 0.02,
					lng: -70.6693 + 0.005,
					name: "Refugio Esperanza",
					description: "Refugio para perros y gatos abandonados",
					address: "Av. Providencia 1234, Santiago",
					phone: "+56 2 2345 6789",
					hours: "Lun-Vie: 9:00-18:00, Sáb: 9:00-14:00"
				},
				{
					lat: -33.4489 - 0.015,
					lng: -70.6693 - 0.02,
					name: "Hogar Animal Feliz",
					description: "Centro de rescate y adopción",
					address: "Calle Los Aromos 567, Santiago",
					phone: "+56 2 2876 5432",
					hours: "Mar-Dom: 10:00-17:00"
				},
				{
					lat: -33.4489 + 0.008,
					lng: -70.6693 - 0.025,
					name: "Fundación Patitas",
					description: "Refugio especializado en animales heridos",
					address: "Pasaje San Juan 890, Santiago",
					phone: "+56 2 2654 3210",
					hours: "Lun-Sáb: 8:00-19:00"
				},
				{
					lat: -33.4489 - 0.005,
					lng: -70.6693 + 0.03,
					name: "Casa Cuna Animal",
					description: "Refugio temporal y adopciones",
					address: "Av. Las Condes 2345, Santiago",
					phone: "+56 2 2987 6543",
					hours: "Lun-Vie: 9:30-17:30"
				}
			];

			sampleShelters.forEach(shelter => {
				const marker = L.marker([shelter.lat, shelter.lng], {
					icon: L.divIcon({
						className: 'custom-div-icon shelter-marker',
						html: '<div style="background-color: #28a745; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.4);">🏠</div>',
						iconSize: [32, 32],
						iconAnchor: [16, 16]
					})
				})
				.addTo(map)
				.bindPopup(`
					<div class="popup-content shelter-popup">
						<div class="popup-title">${shelter.name}</div>
						<div class="popup-description">${shelter.description}</div>
						<div class="shelter-details">
							<div class="shelter-info">
								<strong>📍 Dirección:</strong><br>
								${shelter.address}
							</div>
							<div class="shelter-info">
								<strong>📞 Teléfono:</strong><br>
								<a href="tel:${shelter.phone}">${shelter.phone}</a>
							</div>
							<div class="shelter-info">
								<strong>🕒 Horarios:</strong><br>
								${shelter.hours}
							</div>
						</div>
					</div>
				`);
				
				shelterMarkers.push(marker);
			});
		}
		document.addEventListener('DOMContentLoaded', function() {
			console.log('DOM cargado, esperando 500ms antes de inicializar mapa...');
			setTimeout(() => {
				initMap();
			}, 500);
		});

		// También inicializar cuando la ventana se carga completamente
		window.addEventListener('load', function() {
			console.log('Ventana cargada completamente');
			if (!mapInitialized) {
				console.log('Mapa no inicializado, intentando nuevamente...');
				setTimeout(() => {
					initMap();
				}, 200);
			}
		});
	</script>

	<div class="row footer compact">
		<div class="column">
			<a class="button bg-redpale round" role="button" href="account.html"><span class="icon" data-icon="pets"></span></a>
		</div>
		<div class="column">
			<button id="reportButton" class="button bg-red round size-largest" role="button" onclick="loadModal('templates/reportModal.html')"><span class="icon" data-icon="warning"></span></button>
		</div>
		<div class="column">
			<a class="button bg-redpale round" role="button" href="messages.html"><span class="icon" data-icon="chat"></span></a>
		</div>
	</div>

</body>