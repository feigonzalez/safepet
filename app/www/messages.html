<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/custom/messages.css">
    <script src="assets/app.js"></script>
    <script src="assets/main.js"></script>
    <script src="assets/connect.js"></script>
    <!--script src="assets/custom/messages.js"></script-->

    <script>
		var messages;
		async function beforeLoad(){
			if(!userData.account_id){
				document.querySelector("#messagesList .card").outerHTML=`
					<div class="row ta-center">
					<p>Cuando hagas un reporte de mascota perdida, el dueño de la mascota podrá ponerse en contacto contigo.</p>
					</div>`;
			} else {
				let response = await request(SERVER_URL+"getLatestChats.php",{"account_id":userData.account_id})
				if(response.status=="MISS"){
					document.querySelector("#messagesList .card").innerHTML="No tienes conversaciones activas";
				} else {
					messages=response.messages;
					for(let m of messages){
						m.recency = getRecency(m.timestamp);
					}
					fillIterable(document.querySelector("[foreach=messages]"),messages)
					
					//Actualiza la recencia (qué tan reciente es) de los mensajes de la lista
					setInterval(()=>{
						for(let timestamp of document.querySelectorAll(".timestamp")){
							timestamp.textContent=getRecency(parseInt(timestamp.dataset.time));
						}
					},15000)
				}
			}
		}
    </script>
	
</head>
<body class="column">
    <div class="row header">
        <button id="backButton" class="column compact"><span class="icon" data-icon="chevron-left"></span></button>
        <h1>Mensajes</h1>
    </div>
    <div class="row">
        <div id="messagesList" class="column list size-full-width">
	
		<!-- Debería ser un template con un atributo foreach="chats" o algo parecido -->
			<div class="card row compact chatItem" await foreach="messages">
				<a href="chat.html?id=${paircode}" class="row">
					<div class="column msgItem ta-left">
						<div class="row chatHeader">
							<div class="column compact"><div class="msgAvatar" data-imgsrc="media/dargon.jpg"></div></div>
							<div class="column ta-left">Dueño de Dargón</div>
							<div class="column ta-right compact no-wrap"><div class="timestamp" data-time="${timestamp}" content="${recency}"></div></div>
						</div>
						<div class="chatContent row">
							<div class="column ta-left lastMessage" content="${content}"></div>
							<!--div class="column compact"><div class="unreadBadge">2</div></div-->
						</div>
					</div>
				</a>
            </div>
        </div>
    </div>
</body>